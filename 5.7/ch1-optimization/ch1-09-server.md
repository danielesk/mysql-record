# 优化MySQL服务器


本节讨论数据库服务器的优化技术，主要处理系统配置而不是调优SQL语句。本节中的信息适用于希望确保所管理服务器的性能和可伸缩性的DBA;用于构建包括设置数据库的安装脚本的开发人员;和人们自己运行MySQL进行开发，测试等等，他们希望最大限度地提高自己的工作效率。

## 9.1 系统因素

某些系统级因素可能会以一种主要方式影响性能：
• 如果您有足够的RAM，则可以删除所有交换设备。即使您有空闲内存，某些操作系统也会在某些情况下使用交换设备。
• 避免`MyISAM`表的外部锁定。默认设置是禁用外部锁定。`--external-locking`和`--skip-external-locking`选项显式启用和禁用外部锁定。

只要您只运行一台服务器，禁用外部锁定不会影响MySQL的功能。在运行`myisamchk`之前，请记住取下服务器（或锁定并刷新相关表）。在某些系统上，必须禁用外部锁定，因为它无论如何都不起作用。

您无法禁用外部锁定的唯一情况是，您在同一数据上运行多个MySQL服务器（而非客户端），或者运行`myisamchk`以检查（不修复）表而不告诉服务器先刷新并锁定表。请注意，除了使用NDB Cluster之外，通常不建议使用多个MySQL服务器同时访问相同的数据。

`LOCK TABLES`和`UNLOCK TABLES`语句使用内部锁定，因此您可以使用它们即使禁用外部锁定。


## 9.2 优化磁盘 I/O

本节介绍在您可以投入更多和更快速度时配置存储设备的方法存储硬件到数据库服务器。

• 磁盘搜索是一个巨大的性能瓶颈。当数据量开始增长到无法实现有效缓存时，这个问题就变得更加明显了。对于您或多或少随机访问数据的大型数据库，您可以确保至少需要一个磁盘读取和一些磁盘寻求写入内容。要最小化此问题，请使用寻道时间较短的磁盘。
• 通过将文件符号链接到不同磁盘或条带化磁盘来增加可用磁盘轴数（从而减少搜索开销）：
• 使用符号链接

这意味着，对于MyISAM表，您将索引文件和数据文件从它们在数据目录中的通常位置符号链接到另一个磁盘（也可能是条带化的）。这使得搜索和读取时间都更好，假设磁盘也不用于其他目的。

InnoDB表不支持符号链接。但是，可以将InnoDB数据和日志文件放在不同的物理磁盘上。

• Striping

条带化意味着您有许多磁盘并将第一个块放在第一个磁盘上，第二个块放在第二个磁盘上，第N个块放在（`N MOD number_of_disks`）磁盘上，依此类推。这意味着如果您的正常数据大小小于条带大小（或完全对齐），您将获得更好的性能。条带化非常依赖于操作系统和条带大小，因此使用不同的条带大小对应用程序进行基准测试。

条带化的速度差异很大程度上取决于参数。根据您设置条带化参数和磁盘数量的方式，您可能会获得以数量级计量的差异。您必须选择优化随机或顺序访问。

• 为了可靠性，您可能需要使用RAID 0 + 1（条带加镜像<striping plus mirroring>），但在这种情况下，您需要2×N驱动器可容纳N个数据驱动器。如果您有钱，这可能是最好的选择。但是，您可能还需要投资一些卷管理软件来有效地处理它。
• 一个好的选择是根据数据类型的重要程度来改变RAID级别。例如，存储可在RAID 0磁盘上重新生成的半重要数据，但在RAID 0 + 1或RAID N磁盘上存储非常重要的数据，如主机信息和日志。如果您有多次写入，由于更新奇偶校验位所需的时间，RAID N可能会出现问题。
• 您还可以设置数据库使用的文件系统的参数：如果您不需要知道上次访问文件的时间（这在数据库服务器上没有用），您可以使用`-o noatime`挂载文件系统选项。这会跳过文件系统上inode中最后一次访问时间的更新，从而避免了一些磁盘搜索。
在许多操作系统上，您可以通过使用-o async选项挂载来设置要异步更新的文件系统。如果您的计算机相当稳定，这应该可以在不牺牲太多可靠性的情况下提供更好的性能。 （默认情况下，此标志在Linux上处于启用状态。）

## 9.3 使用 NFS 和 MySQL

在考虑将NFS与MySQL一起使用时，建议小心。潜在问题因操作系统和NFS版本而异，包括：

- 放置在NFS卷上的MySQL数据和日志文件将被锁定且无法使用。例如，由于断电导致MySQL的多个实例访问同一数据目录或MySQL被不正确地关闭的情况，可能会发生锁定问题。 NFS版本4通过引入咨询和基于租约的锁定来解决潜在的锁定问题。但是，不建议在MySQL实例之间共享数据目录。

- 由于接收到的消息顺序错误或丢失了网络流量而导致的数据不一致。为了避免这个问题，使用带有`hard`和`intr`挂载选项的TCP。

- 最大文件大小限制。 NFS版本2客户端只能访问文件的最低2GB（带符号的32位偏移）。 NFS版本3客户端支持更大的文件（最多64位偏移）。支持的最大文件大小还取决于NFS服务器的本地文件系统。

在专业SAN环境或其他存储系统中使用NFS往往比在此类环境之外使用NFS提供更高的可靠性。但是，SAN环境中的NFS可能比直接连接或总线连接的非旋转存储更慢。

如果选择使用NFS，则建议使用NFS版本4或更高版本，以及在部署到生产环境之前彻底测试NFS设置。

## 9.4 使用符号链接

您可以将数据库或表从数据库目录移动到其他位置，并使用指向新位置的符号链接替换它们。您可能希望这样做，例如，将数据库移动到具有更多可用空间的文件系统，或者通过将表扩展到不同的磁盘来提高系统的速度。

对于`InnoDB`表，请使用`CREATE TABLE`语句中的`DATA DIRECTORY`子句而不是符号链接。此新功能是一种受支持的跨平台技术。

建议的方法是将整个数据库目录符号链接到其他磁盘。 Symlink `MyISAM`表仅作为最后的手段。

要确定数据目录的位置，请使用以下语句：

```mysql
SHOW VARIABLES LIKE 'datadir';
```

### 9.4.1 在Unix上使用数据库的符号链接

在Unix上，符号链接数据库的方法是首先在某个磁盘上创建一个目录，在该磁盘上有可用空间，然后从MySQL数据目录创建一个到它的软链接。

```bash
shell> mkdir /dr1/databases/test
shell> ln -s /dr1/databases/test /path/to/datadir
```

MySQL不支持将一个目录链接到多个数据库。只要不在数据库之间建立符号链接，就可以使用符号链接替换数据库目录。假设您在MySQL数据目录下有一个数据库`db1`，然后创建一个指向`db1`的符号链接`db2`：

```bash
shell> cd /path/to/datadir
shell> ln -s db1 db2
```

结果是，对于`db1`中的任何表`tbl_a`，`db2`中似乎还有一个表`tbl_a`。如果一个客户端更新`db1.tbl_a`而另一个客户端更新`db2.tbl_a`，则可能会出现问题。

### 9.4.2 在Unix上使用MyISAM表的符号链接

只有MyISAM表才支持符号链接。对于表用于其他存储引擎的文件，如果尝试使用符号链接，可能会遇到奇怪的问题。(对于InnoDB表，请使用第14.6.3.6节“在数据目录外创建表空间”中说明的替代技术。)

不要在没有完全可操作的`realpath()`调用的系统上进行符号链接表。(Linux和Solaris支持`realpath()`)。要确定您的系统是否支持符号链接，请使用以下语句检查`has_symlink`系统变量的值：

```mysql
SHOW VARIABLES LIKE 'have_symlink';
```

处理MyISAM表的符号链接的工作方式如下：

- 在数据目录中，始终具有表格式（`.frm`）文件，数据（`.MYD`）文件和索引（`.MYI`）文件。数据文件和索引文件可以移动到其他位置，并通过符号链接在数据目录中替换。格式文件不能。

- 您可以将数据文件和索引文件独立地符号链接到不同的目录。

- 要指示正在运行的MySQL服务器执行符号链接，请使用DATA DIRECTORY和INDEX DIRECTORY选项来创建表。或者，如果mysqld未运行，则可以使用命令行中的ln -s手动完成符号链接。

`注意`
与DATA DIRECTORY和INDEX DIRECTORY选项之一或两者一起使用的路径可能不包括MySQL数据目录。 （Bug 32167）
`注意`

- `myisamchk`不会用数据文件或索引文件替换符号链接。它直接在符号链接指向的文件上工作。在数据文件或索引文件所在的目录中创建任何临时文件。 `ALTER TABLE`，`OPTIMIZE TABLE`和`REPAIR TABLE`语句也是如此。

`注意`
删除使用符号链接的表时，符号链接和符号链接指向的文件都将被删除。这是一个非常好的理由，不能将`mysqld`作为`root`操作系统用户运行，或允许操作系统用户具有对MySQL数据库目录的写访问权。
`注意`

- 如果使用`ALTER TABLE ... RENAME`或`RENAME TABLE`重命名表，并且不将表移动到另一个数据库，则数据库目录中的符号链接将重命名为新名称，并相应地重命名数据文件和索引文件。

- 如果使用`ALTER TABLE ... RENAME`或`RENAME TABLE`将表移动到另一个数据库，则表将移动到另一个数据库目录。如果表名更改，则新数据库目录中的符号链接将重命名为新名称，并相应地重命名数据文件和索引文件。

- 如果您没有使用符号链接，请使用`--skip-symbolic-links`选项启动`mysqld`，以确保没有人可以使用`mysqld`删除或重命名数据目录之外的文件。

不支持这些表符号链接操作：

`ALTER TABLE`忽略`DATA DIRECTORY`和`INDEX DIRECTORY`表选项。

如前所述，只有数据和索引文件可以是符号链接。 `.frm`文件绝不能是符号链接。尝试执行此操作（例如，使一个表名称成为另一个表名称的同义词）会产生不正确的结果。假设您在MySQL下有一个数据库`db1`数据目录，此数据库中的表tbl1，以及在db1目录中创建指向tbl1的符号链接tbl2：

```bash
shell> cd / path / to / datadir / db1
shell> ln -s tbl1.frm tbl2.frm
shell> ln -s tbl1.MYD tbl2.MYD
shell> ln -s tbl1.MYI tbl2.MYI
```

如果一个线程读取`db1.tbl1`而另一个线程更新`db1.tbl2`，则会出现问题：

- 查询缓存被“欺骗”（它无法知道tbl1尚未更新，所以它返回过时的结果）。

- `tbl2`上的`ALTER`语句失败。

### 9.4.3 在Windows上使用数据库的符号链接

..........

## 9.5 优化内存使用

### 9.5.1 MySQL如何使用内存

MySQL分配缓冲区和缓存以提高数据库操作的性能。默认配置旨在允许MySQL服务器在具有大约512MB RAM的虚拟机上启动。您可以通过增加某些缓存和缓冲区相关系统变量的值来提高MySQL性能。您还可以修改默认配置以在内存有限的系统上运行MySQL。

以下列表描述了MySQL使用内存的一些方法。适用时，引用相关的系统变量。某些项目是存储引擎或特定功能。

`InnoDB`缓冲池是一个内存区域，用于保存表，索引和其他辅助缓冲区的缓存`InnoDB`数据。为了提高大容量读取操作的效率，缓冲池被分成可以容纳多行的页面。为了提高缓存管理的效率，缓冲池被实现为链接的页面列表;使用LRU算法的变体，很少使用的数据在缓存中老化。

缓冲池的大小对系统性能很重要：

- 1 `InnoDB`使用`malloc()`操作在服务器启动时为整个缓冲池分配内存.`innodb_buffer_pool_size`系统变量定义缓冲池大小。通常，推荐的`innodb_buffer_pool_size`值是系统内存的50％到75％。在服务器运行时，可以动态配置`innodb_buffer_pool_size`。

- 2 在具有大量内存的系统上，可以通过将缓冲池划分为多个缓冲池实例来提高并发性。 `innodb_buffer_pool_instances`系统变量定义缓冲池实例的数量。

- 3 太小的缓冲池可能会导致过度搅动，因为从缓冲池中刷新页面后不久就需要再次刷新。

- 4 过大的缓冲池可能会因内存竞争而导致交换。

- 所有线程共享MyISAM密钥缓冲区。 key_buffer_size系统变量确定其大小。

对于服务器打开的每个MyISAM表，索引文件打开一次;为访问该表的每个并发运行的线程打开一次数据文件。对于每个并发线程，分配表结构，每列的列结构和大小为3 * N的缓冲区（其中N是最大行长度，不计算BLOB列）。 BLOB列需要五到八个字节加上BLOB数据的长度。 MyISAM存储引擎维护一个额外的行缓冲区供内部使用。

















































































































